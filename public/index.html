<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">

    <title>Dein Sparfuchs Agent</title>

    <link rel="manifest" href="/manifest.json">

    <link type="text/css" rel="stylesheet" href="/firebaseui.css" />
</head>

<body>
    <div class="container-url" style="display: none;">
        hello enter product url here: <input type="text" class="input-url"></input>
        <br />
        <button class="button-submit">submit</button>
    </div>

    <div id="firebaseui-auth-container" style="display: none;"></div>

    <script src="/zepto.min.js"></script>
    <script src="/firebase.js"></script>
    <script src="/firebaseui.js"></script>
    <script>
        var SERVER_URL = "https://sparfuchs-agent.herokuapp.com";

        var messaging;
        var userKey;

        function initializeFirebase() {
            var config = {
                apiKey: "AIzaSyBWMWMExk-jpZHDUaci6262sej5lEimlug",
                authDomain: "sparfuchs-agent.firebaseapp.com",
                databaseURL: "https://sparfuchs-agent.firebaseio.com",
                storageBucket: "sparfuchs-agent.appspot.com",
                messagingSenderId: "643626212515"
            };
            firebase.initializeApp(config);

            messaging = firebase.messaging();
        }

        function saveDeviceToken() {
            var promise = messaging.getToken();
            promise = promise.then(function(deviceToken) {
                var requestOptions = {};
                requestOptions.method = "POST";
                requestOptions.url = SERVER_URL + "/user/device?userKey=" + userKey + "&deviceToken=" + deviceToken;

                var promise = $.ajax(requestOptions);
                return promise;
            });

            return promise;
        }

        function initializeUi() {
            var urlContainer = $(".container-url");
            var submitButton = $(".button-submit");
            submitButton.click(function() {
                var productUrl = $(".input-url").val();

                var requestOptions = {};
                requestOptions.method = "POST";
                requestOptions.url = SERVER_URL + "/product?userKey=" + userKey + "&productUrl=" + productUrl;

                var promise = $.ajax(requestOptions);
                promise.done(console.log);
                promise.fail(console.error);
            });

            var uiConfig = {
                signInSuccessUrl: "/",
                signInOptions: [
                    firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                    firebase.auth.EmailAuthProvider.PROVIDER_ID
                ]
            };

            var ui = new firebaseui.auth.AuthUI(firebase.auth());
            ui.start("#firebaseui-auth-container", uiConfig);

            firebase.auth().onAuthStateChanged(function(user) {
                urlContainer.toggle(!!user);
                $("#firebaseui-auth-container").toggle(!user);

                if (user) {
                    userKey = user.uid;

                    initializeMessaging();
                }
            });
        }

        function initializeMessaging() {
            messaging.onTokenRefresh(saveDeviceToken);

            var promise = messaging.requestPermission();
            promise = promise.then(saveDeviceToken);
            promise.catch(console.error);

            messaging.onMessage(console.log);
        }

        initializeFirebase();

        initializeUi();
    </script>
</body>

</html>
